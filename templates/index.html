<!DOCTYPE html>
<html {% if location %}lang="{{location.lang}}" {% endif %} {% if current_user.is_authenticated %}id={{current_user.id}}{% endif %} {% if current_user.is_authenticated and current_user.theme == 'Dark' %}data-theme="dark"{% endif %}>
<head>
  {% if error_check != True %}
  {% if request.url_rule.endpoint == 'home.home' %}<title>New App - Where Developers Learn, Share, & Code</title>{% endif %}
  {% if request.url_rule.endpoint == 'users.user' %}<title>{{user.name[0]|upper}}{{user.name[1:]}} - NewApp</title>{% endif %}
  {% if request.url_rule.endpoint == 'home.post' %}<title>{{posts.title}} - NewApp</title>{% endif %}
  <meta charset="utf-8">
  <meta name="msvalidate.01" content="FA1B41824E0AF3D2CC7B0F86730E5C45" />
  <meta name="yandex-verification" content="c303cb257b715901" />
  <link rel='icon' href="https://newapp.nl/static/favicon_web.png" type='image/x-icon' />
  <link rel="preconnect" href="https://newappcdn.b-cdn.net/" crossorigin>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  {% if request.url_rule.endpoint == 'home.home' %}
  <script type="application/ld+json">    
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "url": "https://newapp.nl/",
      "potentialAction": {
        "@type": "SearchAction",
        "target": "https://newapp.nl/search={search_term_string}",
        "query-input": "required name=search_term_string"
      }
    }
  </script>
  <meta name="keywords" content="newapp,forum,developers,web">
  {% endif %}
  {% if request.url_rule.endpoint == 'home.post' %}
  <meta name="keywords" content="{% for key in keywords %}{{key}},{% endfor %}newapp">
  {% endif %}
  {% if request.url_rule.endpoint == 'users.user' %}
  <meta name="keywords" content="newapp,{{user.name}}">
  {% endif %}
  <meta name="theme-color" content="rgb(34, 34, 34)" />
  <meta name="application-name" content="NewApp">
  <meta name="apple-mobile-web-app-title" content="NewApp">
  {% if request.url_rule.endpoint == 'home.home' %}
  <meta name="description" content="NewApp the newest community for developers to learn, share​ ​their programming ​knowledge, and build their careers.">
  {% endif %}
  {% if request.url_rule.endpoint == 'users.user' %}
  <meta name="description" content="{{user.name}} - {{user.bio}}">
  {% endif %}
  {% if request.url_rule.endpoint == 'home.post' %}
  <meta name="description" content="{{posts.text[35:100]}}">
  {% endif %}
  <link rel="canonical" href="https://newapp.nl{{ request.path }}">
  <link rel="manifest" href="https://newapp.nl/static/manifest.json">
  <link rel="alternate" type="application/rss+xml" title="NewApp RSS Feed" href="https://newapp.nl/feed">
  {% if location %}
  <meta http-equiv="content-language" content="{{location.lang}}">{% endif %}
  <link rel="search" type="application/opensearchdescription+xml" title="NewApp" href="https://newapp.nl/opensearch">
  {% if request.url_rule.endpoint == 'home.home' %}
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://newapp.nl/">
  <meta property="og:site_name" content="New App">
  <meta property="og:description"
    content="The newest community for developers to learn, share​ ​their programming ​knowledge, and build their careers.">
  {% elif request.url_rule.endpoint == 'users.user' %}
  <meta property="og:type" content="website">
  <meta property="og:url" content="{{request.path}}">
  <meta property="og:site_name" content="{{user.name}}">
  <meta property="og:image" itemprop="image primaryImageOfPage" content="https://newapp.nl{{user.avatar}}">
  <meta property="og:description" content="{{user.bio}}">
  {% elif request.url_rule.endpoint == 'home.post' %}
  <meta property="og:type" content="website">
  <meta property="og:url" content="{{request.path}}">
  <meta property="og:site_name" content="{{posts.title}}">
  {% if posts.thumbnail %}
  <meta property="og:image" itemprop="image primaryImageOfPage" content="https://newapp.nl/static/thumbnail_post/post_{{posts.id}}.jpeg">
  {% else %}
  <meta property="og:image" itemprop="image primaryImageOfPage" content="https://newapp.nl/static/favicon.png">
  {% endif %}
  <meta property="og:description" content="{{posts.text[3:100]}}">
  {% endif %}
  {% endif %}
  <meta name="environment" content="production">
  <script async src="https://newappcdn.b-cdn.net/newapp.min.js"></script>
  <!-- <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script> -->
  <script async src="https://newappcdn.b-cdn.net/jquery.js"></script>
  <!-- <script async src="https://code.jquery.com/jquery-3.3.1.min.js"></script> -->
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
  {% include 'style.html' %}
</head>
<header>
  {% include 'navbar.html' %}
</header>
<reload style="height: 3rem;display:block"></reload>
<content>
  {% if error_check != True %}
    {% if request.MOBILE %}
      {% if request.url_rule.endpoint == 'home.home' %}
      <!-- <div class="open-wrapper">
          <i class="fas fa-coins fa-lg" id="open-wrapper" onclick="openNav()"></i>
      </div> -->
        {% include 'wrapper_left.html' %}
      {% endif %}
    {% else %}
        {% include 'sidebar_left.html' %}
    {% endif %}
  {% endif %}
    {% block content %}
    {% endblock %}
  {% if error_check != True %}
    {% include 'sidebar_right.html' %}
  {% endif %}
</content>
{% include 'modals.html' %}
<script>
  const imageHandler = () => {
  const input = document.createElement('input');

  input.setAttribute('type', 'file');
  input.setAttribute('accept', 'image/*');
  input.click();

  input.onchange = async () => {
    const file = input.files[0];
    const formData = new FormData();

    formData.append('image', file);

    // Save current cursor state
    const range = this.quill.getSelection(true);

    // Insert temporary loading placeholder image
    //this.quill.insertEmbed(range.index, 'image', `${ window.location.origin }{{url_for('static',filename='loading/loading.gif')}}`); 

    // Move cursor to right side of image (easier to continue typing)
    this.quill.setSelection(range.index + 1);

    // Post to an api endpoint which uploads to s3. It returns the s3 url

    var res = null;

    await $.ajax({
      type : 'POST',
      url : window.location.origin + '/api/upload_post',
      data: formData,
      contentType: false,
      processData: false,
      success: function(data){
        res = data.image
      }
    })
    
    // Remove placeholder image
    this.quill.deleteText(range.index, 1);

    // Insert uploaded image
    this.quill.insertEmbed(range.index, 'image', res); 
  }
}
</script>
<script>
  var quill = null;
  var loadCss = function(cssPath){
    var cssLink = document.createElement('link');
    cssLink.rel = 'stylesheet';
    cssLink.href = cssPath;
    var head = document.getElementsByTagName('head')[0];
    head.appendChild(cssLink);
  };
  var loadJs = function(cssPath){
    var cssLink = document.createElement('script');
    cssLink.src = cssPath;
    var head = document.getElementsByTagName('head')[0];
    head.appendChild(cssLink);
  };
  window.onload = function () {
    loadCss("https://newappcdn.b-cdn.net/all.css");
    loadCss("https://newappcdn.b-cdn.net/styles.css");
    loadJs("https://www.googletagmanager.com/gtag/js?id=UA-145440871-1");
    var x232 = document.getElementsByTagName("HTML")[0];
    if (x232.getAttribute("data-theme") == "dark"){
      loadCss("https://newappcdn.b-cdn.net/dark_code.css");
    }
    else{
      loadCss("https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/prettify.css");
    }
    setTimeout(init_NewApp,1000);
    window.dataLayer = window.dataLayer || [];

    function gtag() {
      dataLayer.push(arguments);
    }
    gtag('js', new Date());

    gtag('config', 'UA-145440871-1', {
      'optimize_id': 'GTM-KKCQ2T7'
    });
    {% if current_user.is_authenticated %}
    gtag('set', {'user_id': '{{current_user.id}}'});
    {% endif %}
    {%  if request.endpoint == 'home.home' %}
    LoadTrending();
    {% elif request.endpoint == 'home.post' %}
    LoadTrending();
    {% endif %}
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register("https://" + window.location.hostname + "/sw.js").then(function(registration) {
          // Registration was successful
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
        }, function(err) {
          // registration failed :(
          console.log('ServiceWorker registration failed: ', err);
        });
      });
    
    };
    {% if current_user.is_authenticated %}
    {% if request.url_rule.endpoint == 'home.post' or request.url_rule.endpoint == 'home.newpost' or request.url_rule.endpoint == 'home.edit_post' %}
    var toolbarOptions = [
      ['bold', 'italic', 'underline'],
      ['blockquote', 'code-block'],
      ['link', 'image'],
      [{
          'header': [1, 2, 3, 4, 5, 6, false]
      }],
      [{
          'color': []
      }, {
          'background': []
      }],
      [{
          'font': []
      }],
      [{
          'align': []
      }],
    ];
    function LoadQuill(){
        quill = new Quill('#editor', {
            modules: {
                toolbar: {
                  container: toolbarOptions,
                  handlers: {
                      image: imageHandler
                  },
                }
            },
            theme: 'snow',
        });
    }
  
    jQuery(document).ready(function() {
      LoadQuill();
      PR.prettyPrint();
      jQuery(".form-thread").submit(function() { 
          var hidden_text_field = document.getElementById('text');
          hidden_text_field.value = decodeURIComponent(encodeURIComponent(String(document.querySelector(".ql-editor").innerHTML)));
      });
      {% if request.url_rule.endpoint == 'home.edit_post' %}
      quill.pasteHTML(document.getElementById('text').value);
      {% endif %}
    });
    
    {% endif %}
    {% endif %}
    jQuery(document).ready(function() {
    window.setTimeout(function() {
        $("alert-box").fadeTo(500, 0).slideUp(500, function(){
            $(this).remove(); 
        });
      }, 500);
    });
    {% if request.MOBILE %}
    PullToRefresh.init({
      mainElement: 'content', // above which element?
      onRefresh: function (done) {
        setTimeout(function () {
          done(); // end pull to refresh
          window.location.reload(false);
        }, 1500);
      }
      });
    {% endif %}
  };
  {% if request.url_rule.endpoint == 'users.settings' %}
  function ShowMisc(){
    var x = document.getElementById('main');
    x.style.display = 'none';
    x = document.getElementById('misc');
    x.style.display = {% if request.MOBILE %}'block'{% else %}'flex'{% endif %};
  }
  function ShowMain(){
    var x = document.getElementById('misc');
    x.style.display = 'none';
    x = document.getElementById('main');
    x.style.display = {% if request.MOBILE %}'block'{% else %}'flex'{% endif %};
  }
  {% endif %}
</script>

{% if request.url_rule.endpoint == 'home.home' %}
{% if request.MOBILE %}
<script>
  function openNav() {
    document.getElementById("wrapper-left").style.width = "250px";
    document.getElementById("wrapper-left").style.margin = "0";
    wrapper_opened = true;
  }
  
  function closeNav() {
    document.getElementById("wrapper-left").style.width = "0";
    document.getElementById("wrapper-left").style.margin = "-20px";
    wrapper_opened = false;
  }
</script>
<script>
document.addEventListener('touchstart', handleTouchStart, false);        
document.addEventListener('touchmove', handleTouchMove, false);

var xDown = null;                                                        
var yDown = null;

function getTouches(evt) {
  return evt.touches ||             // browser API
         evt.originalEvent.touches; // jQuery
}                                                     

function handleTouchStart(evt) {
    const firstTouch = getTouches(evt)[0];                                      
    xDown = firstTouch.clientX;                                      
    yDown = firstTouch.clientY;                                      
};                                                

function handleTouchMove(evt) {
    if ( ! xDown || ! yDown ) {
        return;
    }

    var xUp = evt.touches[0].clientX;                                    
    var yUp = evt.touches[0].clientY;

    var xDiff = xDown - xUp;
    var yDiff = yDown - yUp;

    if ( Math.abs( xDiff ) > Math.abs( yDiff ) ) {/*most significant*/
        if ( xDiff > 0 ) {
          closeNav();
        } else {
          openNav();
        }                       
    } else {
        if ( yDiff > 0 ) {
            /* up swipe */ 
        } else { 
            if (yDiff < -15){
              
            }
        }                                                                 
    }
    /* reset values */
    xDown = null;
    yDown = null;                                             
};
</script>
{% endif %}
{% endif %}
</body>

</html>
